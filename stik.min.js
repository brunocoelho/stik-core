// ==========================================================================
// Project:   Stik.js - JavaScript Separation Of Concerns
// Copyright: Copyright 2013-2014 Lukas Alexandre
// License:   Licensed under MIT license
//            See https://github.com/stikjs/stik.js/blob/master/LICENSE
// ==========================================================================

// Version: 1.0.0-alpha | From: 19-04-2014

if(window.stik)throw"Stik is already loaded. Check your requires ;)";window.stik={labs:{}},window.stik.injectable=function(a){function b(b){function c(){}var e,f;return c.prototype=a.module.prototype,e=new c,f=d(e,b),Object(f)===f?f:e}function c(b){var c=window.stik.injector({executionUnit:a.module,modules:b});return c.resolveDependencies()}function d(b,c){var d=a.module.apply(b,c);return e(d),d}function e(b){a.cache===!0&&(a.cachedValue=b)}return a.instantiable=a.instantiable||!1,a.resolvable=a.resolvable||!1,a.cache=a.cache||!1,a.resolve=function(e){return a.cachedValue?a.cachedValue:a.instantiable===!0?b(c(e)):a.resolvable===!0?d({},c(e)):a.module},a},window.stik.createController=function(a){if(!a.name)throw"Stik: Controller needs a name";return a.actions={},a.action=function(b,c){var d=window.stik.action({name:b,controller:a.name,executionUnit:c});return a.actions[b]=d,d},a.bind=function(b){var c,d=!1;for(c in a.actions)a.actions[c].bind(b)&&(d=!0);return d},a},window.stik.action=function(a){function b(b){return{context:window.stik.context({controller:a.controller,action:a.name,template:b}),executionUnit:a.executionUnit}}function c(a){a.className=(a.className+" stik-bound").trim()}if(!a.controller)throw"Stik: Action needs an controller name";if(!a.name)throw"Stik: Action name can't be empty";if(!a.executionUnit)throw"Stik: Action needs a function to use as its execution unit";return a.bind=function(d){for(var e=a.findTemplates(),f=e.length;f--;)b(e[f]).context.load(a.executionUnit,d),c(e[f]);return e.length>0},a.findTemplates=function(b){var c=document;b&&(c=b);var d="[data-controller="+a.controller+"][data-action="+a.name+"]:not([class*=stik-bound])";return c.querySelectorAll(d)},a.bindWithTemplate=b,a},window.stik.context=function(a){function b(a,b){var c=window.stik.injector({executionUnit:a,modules:b});return c.resolveDependencies()}function c(b){return b.$template=a.template,b}return a.template=window.stik.injectable({module:a.template}),a.load=function(d,e){var f=b(d,c(e));d.apply(a,f)},a},window.stik.createBehavior=function(a){function b(b){return{context:window.stik.context({behavior:a.behavior,template:b}),executionUnit:a.executionUnit}}function c(){var b="[class*="+a.name+"]:not([data-behaviors*="+a.name+"])";return document.querySelectorAll(b)}function d(b){var c=b.getAttribute(e);c=((c||"")+" "+a.name).trim(),b.setAttribute(e,c)}if(!a.name)throw"Stik: Behavior name is missing";if(-1!==a.name.indexOf(" "))throw"Stik: '"+a.name+"' is not a valid Behavior name. Please replace empty spaces with dashes ('-')";if(!a.executionUnit)throw"Stik: Behavior needs a function to use as its execution unit";var e="data-behaviors";return a.bind=function(c){for(var e=a.findTemplates(),f=e.length;f--;)b(e[f]).context.load(a.executionUnit,c),d(e[f]);return e.length>0},a.bindWithTemplate=b,a.findTemplates=c,a},window.stik.createBoundary=function(a){if(-1!==a.as.indexOf(" "))throw"Stik: '"+a.as+"' is not a valid Boundary name. Please replace empty spaces with dashes ('-')";if(!a.to)throw"Stik: Boundary needs an object or function as 'to'";var b={};return b.to=window.stik.injectable({module:a.to,instantiable:a.instantiable,resolvable:a.resolvable,cache:a.cache}),b.name=a.as,b},window.stik.injector=function(a){function b(){var b,d,e;return b=/^function\s*[^\(]*\(\s*([^\)]*)\)/m,d=a.executionUnit.toString(),e=d.match(b)[1].split(","),c(e)}function c(a){var b=[];return a.forEach(function(a){b.push(a.trim())}),b}function d(b){var c,d;if(d=[],1===b.length&&""===b[0])return[];for(var e=0;e<b.length;e++){if(!(c=a.modules[b[e]]))throw"Stik could not find this module ("+b[e]+")";d.push(c.resolve(a.modules))}return d}if(!a.executionUnit)throw"Stik: Injector needs a function to use as its execution unit";return a.resolveDependencies=function(){var a=b();return d(a)},a},window.stik.manager=function(){function a(a){var b=window.stik.createController({name:a});return g[a]=b,b}function b(a){return!!f[a]}function c(a,b){return window.stik.createBehavior(a,b)}function d(a){var b,c={};for(b in a)c[b]=a[b].to;for(b in h.all)c[b]=h.all[b].to;return c}function e(a){var b=d(h.controller);a.bind(b)}var f={},g={},h={all:{},controller:{},behavior:{}},i={};return i.addControllerWithAction=function(b,c,e){var f=a(b),g=f.action(c,e);return g.bind(d(h.controller)),f},i.addController=function(b,c){var d=a(b);return c.call({},d),e(d),d},i.addBehavior=function(a,d){if(b(a))throw"Stik: Another behavior already exist with name '"+a+"'";var e=c({name:a,executionUnit:d});return f[a]=e,i.applyBehavior(e),e},i.addBoundary=function(a){var b;if(a.from=a.from||"all",-1===["all","controller","behavior"].indexOf(a.from))throw"Stik: Invalid boundary 'from' specified. Please use 'controller', 'behavior', 'all' or leave it blank to default to 'all'";return b=window.stik.createBoundary(a),h[a.from][a.as]=b,b},i.applyBehaviors=function(){var a,b=!1;for(a in f)i.applyBehavior(f[a])&&(b=!0);return b},i.applyBehavior=function(a){var b=d(h.behavior);return a.bind(b)},i.bindActionWithTemplate=function(a,b,c){var e,f=d(h.controller);return e=g[a].actions[b].bindWithTemplate(c,f),e.modules=f,e},i.bindBehaviorWithTemplate=function(a,b){var c,e=d(h.behavior);return c=f[a].bindWithTemplate(b,e),c.modules=e,c},i.bindActions=function(){var a,b=d(h.controller),c=!1;for(a in g)g[a].bind(b)&&(c=!0);return c},i.getBoundary=function(a){var b,c;for(b in h)for(c in h[b])if(c===a)return h[b][c]},i.$reset=function(){g={},f={}},i},window.stik.$$manager=window.stik.manager(),window.stik.controller=function(a,b,c){return"string"==typeof b?window.stik.$$manager.addControllerWithAction(a,b,c):window.stik.$$manager.addController(a,b)},window.stik.behavior=function(a,b){return window.stik.$$manager.addBehavior(a,b)},window.stik.lazyBind=window.stik.bindLazy=function(){if(!window.stik.$$manager.bindActions()&!window.stik.$$manager.applyBehaviors())throw"Stik: Nothing new to bind!"},window.stik.boundary=function(a){return window.stik.$$manager.addBoundary(a)},window.stik.boundary({as:"$courier",resolvable:!0,cache:!0,to:function(){function a(a,b){var c=new RegExp(a);for(var d in e)c.exec(d)&&b(e[d])}function b(a){e[a.box]=e[a.box].filter(function(b){return b.id!==a.id}),0===e[a.box].length&&delete e[a.box]}function c(a){return a.id="#"+Math.floor(16777215*Math.random()).toString(16),a}var d={},e={};return d.receive=function(a,d){var f=c({box:a,opener:d});return e[a]=e[a]||[],e[a].push(f),b.bind({},f)},d.send=function(b,c){var d=0,e=!1;if(a(b,function(a){for(e=!0,d=a.length;d--;)a[d].opener(c)}),!e)throw"Stik: No receiver registered for '"+b+"'"},d}}),window.stik.boundary({as:"$viewBag",resolvable:!0,to:function(a){function b(a){return e(a)?a.value:a.textContent}function c(a,b){e(a)?a.value=b:a.textContent=b}function d(){return a.getAttribute(g)?[a]:a.querySelectorAll("["+g+"]")}function e(a){return"INPUT"===a.nodeName.toUpperCase()||"TEXTAREA"===a.nodeName.toUpperCase()}if(!a)throw"Stik: ViewBag needs a template to be attached to";var f={},g="data-key";return f.push=function(a){for(var b,e=d(),f=e.length;f--;)b=e[f].getAttribute(g),void 0!==a[b]&&c(e[f],a[b])},f.pull=function(){for(var c,e=d(a),f={},h=e.length;h--;)c=e[h].getAttribute(g),f[c]=b(e[h]);return f},f}}),window.stik.boundary({as:"$data",resolvable:!0,to:function(a){function b(a){return c(a.match(/(data-)(.+)/)[2])}function c(a){return a.replace(/-([a-z])/g,function(a){return a[1].toUpperCase()})}var d,e,f={};for(d in a.attributes)a.attributes[d].value&&(e=a.attributes[d].name,e.match(/^data-/m)&&(f[b(e)]=a.attributes[d].value));return f}}),window.stik.labs.behavior=function(a){function b(){var b=document.implementation.createHTMLDocument();return b.body.innerHTML=a.template,b.body.firstChild}function c(a){for(var b in a)d.modules[b]=window.stik.injectable({module:a[b]});return d.modules}if(!a)throw"Stik: Behavior Lab needs an environment to run";if(!a.name)throw"Stik: Behavior Lab needs a name";if(!a.template)throw"Stik: Behavior Lab needs a template";var d,e={};return e.template=b(),d=window.stik.$$manager.bindBehaviorWithTemplate(a.name,e.template),e.run=function(a){d.context.load(d.executionUnit,c(a))},e},window.stik.labs.controller=function(a){function b(){var b=document.implementation.createHTMLDocument();return b.body.innerHTML=a.template,b.body.firstChild}function c(a){for(var b in a)d.modules[b]=window.stik.injectable({module:a[b]});return d.modules}if(!a)throw"Stik: Controller Lab needs an environment to run";if(!a.name)throw"Stik: Controller Lab needs a name";if(!a.action)throw"Stik: Controller Lab needs the action name";if(!a.template)throw"Stik: Controller Lab needs a template";var d,e={};return e.template=b(),d=window.stik.$$manager.bindActionWithTemplate(a.name,a.action,e.template),e.run=function(a){d.context.load(d.executionUnit,c(a))},e},window.stik.labs.boundary=function(a){function b(a){var b={};for(var c in a)b[c]=window.stik.injectable({module:a[c]});return b}if(!a)throw"Stik: Boundary Lab needs an environment to run";if(!a.name)throw"Stik: Boundary Lab needs a name";var c={},d=window.stik.$$manager.getBoundary(a.name);return c.run=function(a){return d.to.resolve(b(a))},c},window.stik.labs.helper=function(a){if(!a)throw"Stik: Helper Lab needs an environment to run";if(!a.name)throw"Stik: Helper Lab needs a name";var b={},c=window.stik.labs.boundary({name:"$h"});return b.run=function(b){var d=c.run(b);return d.pushDoubles(b),function(){return d[a.name].apply({},arguments)}},b};