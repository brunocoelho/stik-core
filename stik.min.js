// ==========================================================================
// Project:   Stik.js - JavaScript Separation Of Concerns
// Copyright: Copyright 2013-2014 Lukas Alexandre
// License:   Licensed under MIT license
//            See https://github.com/stikjs/stik.js/blob/master/LICENSE
// ==========================================================================

// Version: 0.10.0 | From: 09-03-2014

if(window.stik)throw"Stik is already loaded. Check your requires ;)";window.stik={labs:{}},window.stik.injectable=function(a){function b(b){function c(){}var e,f;return c.prototype=a.module.prototype,e=new c,f=d(e,b),Object(f)===f?f:e}function c(b){var c=window.stik.injector({executionUnit:a.module,modules:b});return c.resolveDependencies()}function d(b,c){return a.module.apply(b,c)}return a.instantiable=a.instantiable||!1,a.resolvable=a.resolvable||!1,a.resolve=function(e){return a.instantiable===!0?b(c(e)):a.resolvable===!0?d({},c(e)):a.module},a},window.stik.createController=function(a){if(!a.name)throw"Stik: Controller needs a name";return a.actions={},a.action=function(b,c){var d=window.stik.action({name:b,controller:a.name,executionUnit:c});return a.actions[b]=d,d},a.bind=function(b){var c,d=!1;for(c in a.actions)a.actions[c].bind(b)&&(d=!0);return d},a},window.stik.action=function(a){function b(b){return{context:window.stik.context({controller:a.controller,action:a.name,template:b}),executionUnit:a.executionUnit}}function c(a){a.className=(a.className+" stik-bound").trim()}if(!a.controller)throw"Stik: Action needs an controller name";if(!a.name)throw"Stik: Action name can't be empty";if(!a.executionUnit)throw"Stik: Action needs a function to use as its execution unit";return a.bind=function(d){for(var e=a.findTemplates(),f=e.length;f--;)b(e[f]).context.load(a.executionUnit,d),c(e[f]);return e.length>0},a.findTemplates=function(b){var c=document;b&&(c=b);var d="[data-controller="+a.controller+"][data-action="+a.name+"]:not([class*=stik-bound])";return c.querySelectorAll(d)},a.bindWithTemplate=b,a},window.stik.context=function(a){function b(a,b){var c=window.stik.injector({executionUnit:a,modules:b});return c.resolveDependencies()}function c(b){return b.$template=a.template,b}return a.template=window.stik.injectable({module:a.template}),a.load=function(d,e){var f=b(d,c(e));d.apply(a,f)},a},window.stik.createBehavior=function(a){function b(b){return{context:window.stik.context({behavior:a.behavior,template:b}),executionUnit:a.executionUnit}}function c(){var b="[class*="+a.name+"]:not([data-behaviors*="+a.name+"])";return document.querySelectorAll(b)}function d(b){var c=b.getAttribute(e);c=((c||"")+" "+a.name).trim(),b.setAttribute(e,c)}if(!a.name)throw"Stik: Behavior name is missing";if(-1!==a.name.indexOf(" "))throw"Stik: '"+a.name+"' is not a valid Behavior name. Please replace empty spaces with dashes ('-')";if(!a.executionUnit)throw"Stik: Behavior needs a function to use as its execution unit";var e="data-behaviors";return a.bind=function(c){for(var e=a.findTemplates(),f=e.length;f--;)b(e[f]).context.load(a.executionUnit,c),d(e[f]);return e.length>0},a.bindWithTemplate=b,a.findTemplates=c,a},window.stik.createBoundary=function(a){if(-1!==a.as.indexOf(" "))throw"Stik: '"+a.as+"' is not a valid Boundary name. Please replace empty spaces with dashes ('-')";if(!a.to)throw"Stik: Boundary needs an object or function as 'to'";var b={};return b.to=window.stik.injectable({module:a.to,instantiable:a.instantiable,resolvable:a.resolvable}),b.name=a.as,b},window.stik.injector=function(a){function b(){var b,d,e;return b=/^function\s*[^\(]*\(\s*([^\)]*)\)/m,d=a.executionUnit.toString(),e=d.match(b)[1].split(","),c(e)}function c(a){var b=[];return a.forEach(function(a){b.push(a.trim())}),b}function d(b){var c,d;if(d=[],1===b.length&&""===b[0])return[];for(var e=0;e<b.length;e++){if(!(c=a.modules[b[e]]))throw"Stik could not find this module ("+b[e]+")";d.push(c.resolve(a.modules))}return d}if(!a.executionUnit)throw"Stik: Injector needs a function to use as its execution unit";return a.resolveDependencies=function(){var a=b();return d(a)},a},window.stik.manager=function(){function a(a){var b=window.stik.createController({name:a});return h[a]=b,b}function b(a,b){for(var c=a.toLowerCase().split("|"),d=c.length;d--;){if("controller"!==c[d]&&"behavior"!==c[d])throw"Stik: Invalid boundary 'from' specified. Please use 'controller' or 'behavior' or leave it blank to default to both";b(c[d])}}function c(a){return!!g[a]}function d(a,b){return window.stik.createBehavior(a,b)}function e(a){var b,c={};for(b in a)c[b]=a[b].to;return c}function f(a){var b=e(i.controller);a.bind(b)}var g={},h={},i={controller:{},behavior:{}},j={};return j.addControllerWithAction=function(b,c,d){var f=a(b),g=f.action(c,d);return g.bind(e(i.controller)),f},j.addController=function(b,c){var d=a(b);return c.call({},d),f(d),d},j.addBehavior=function(a,b){if(c(a))throw"Stik: Another behavior already exist with name '"+a+"'";var e=d({name:a,executionUnit:b});return g[a]=e,j.applyBehavior(e),e},j.addBoundary=function(a){var c;return a.from=a.from||"controller|behavior",b(a.from,function(b){c=window.stik.createBoundary(a),i[b][a.as]=c}),c},j.applyBehaviors=function(){var a,b=!1;for(a in g)j.applyBehavior(g[a])&&(b=!0);return b},j.applyBehavior=function(a){var b=e(i.behavior);return a.bind(b)},j.bindActionWithTemplate=function(a,b,c){var d,f=e(i.controller);return d=h[a].actions[b].bindWithTemplate(c,f),d.modules=f,d},j.bindBehaviorWithTemplate=function(a,b){var c,d=e(i.behavior);return c=g[a].bindWithTemplate(b,d),c.modules=d,c},j.bindActions=function(){var a,b=e(i.controller),c=!1;for(a in h)h[a].bind(b)&&(c=!0);return c},j.getBoundary=function(a){for(type in i)for(boundaryName in i[type])if(boundaryName===a)return i[type][boundaryName]},j.$reset=function(){h={},g={}},j},window.stik.$$manager=window.stik.manager(),window.stik.controller=function(a,b,c){return"string"==typeof b?window.stik.$$manager.addControllerWithAction(a,b,c):window.stik.$$manager.addController(a,b)},window.stik.behavior=function(a,b){return window.stik.$$manager.addBehavior(a,b)},window.stik.bindLazy=function(){if(!window.stik.$$manager.bindActions()&!window.stik.$$manager.applyBehaviors())throw"Stik: Nothing new to bind!"},window.stik.boundary=function(a){return window.stik.$$manager.addBoundary(a)},function(){var a={},b={};window.stik.helper=function(c,d){if(!c)throw"Stik: Helper needs a name";if(!d||"function"!=typeof d)throw"Stik: Helper needs a function";return b[c]=window.stik.injectable({module:d,resolvable:!0}),a[c]=function(){return b[c].resolve(b).apply({},arguments)},a[c]},window.stik.boundary({as:"$h",to:a})}(),window.stik.courier=function(){function a(a,b){var c=new RegExp(a);for(sub in e)c.exec(sub)&&b(e[sub])}function b(a){e[a.box]=e[a.box].filter(function(b){return b.id!==a.id}),0===e[a.box].length&&delete e[a.box]}function c(a){return a.id="#"+Math.floor(16777215*Math.random()).toString(16),a}var d={},e={};return d.$receive=function(a,d){var f=c({box:a,opener:d});return e[a]=e[a]||[],e[a].push(f),b.bind({},f)},d.$send=function(b,c){var d=0,e=!1;if(a(b,function(a){for(e=!0,d=a.length;d--;)a[d].opener(c)}),!e)throw"Stik: No receiver registered for '"+b+"'"},d},window.stik.boundary({as:"$courier",to:window.stik.courier()}),window.stik.viewBag=function(a){function b(a){return e(a)?a.value:a.textContent}function c(a,b){e(a)?a.value=b:a.textContent=b}function d(){return a.getAttribute(g)?[a]:a.querySelectorAll("["+g+"]")}function e(a){return"INPUT"===a.nodeName.toUpperCase()||"TEXTAREA"===a.nodeName.toUpperCase()}if(!a)throw"Stik: ViewBag needs a template to be attached to";var f={},g="data-key";return f.$push=function(a){for(var b,e=d(),f=e.length;f--;)b=e[f].getAttribute(g),void 0!==a[b]&&c(e[f],a[b])},f.$pull=function(){for(var c,e=d(a),f={},h=e.length;h--;)c=e[h].getAttribute(g),f[c]=b(e[h]);return f},f},window.stik.boundary({as:"$viewBag",resolvable:!0,to:window.stik.viewBag}),stik.boundary({as:"$params",resolvable:!0,to:function(a){function b(a){return a.match(/(data-)(.+)/)[2]}var c,d={};for(attr in a.attributes)a.attributes[attr].value&&(c=a.attributes[attr].name,d[b(c)]=a.attributes[attr].value);return d}}),window.stik.labs.behavior=function(a){function b(){var b=document.implementation.createHTMLDocument();return b.body.innerHTML=a.template,b.body.firstChild}function c(a){for(dbl in a)d.modules[dbl]=window.stik.injectable({module:a[dbl]});return d.modules}if(!a)throw"Stik: Behavior Lab needs an environment to run";if(!a.name)throw"Stik: Behavior Lab needs a name";if(!a.template)throw"Stik: Behavior Lab needs a template";var d,e={};return e.template=b(),d=window.stik.$$manager.bindBehaviorWithTemplate(a.name,e.template),e.run=function(a){d.context.load(d.executionUnit,c(a))},e},window.stik.labs.controller=function(a){function b(){var b=document.implementation.createHTMLDocument();return b.body.innerHTML=a.template,b.body.firstChild}function c(a){for(dbl in a)d.modules[dbl]=window.stik.injectable({module:a[dbl]});return d.modules}if(!a)throw"Stik: Controller Lab needs an environment to run";if(!a.name)throw"Stik: Controller Lab needs a name";if(!a.action)throw"Stik: Controller Lab needs the action name";if(!a.template)throw"Stik: Controller Lab needs a template";var d,e={};return e.template=b(),d=window.stik.$$manager.bindActionWithTemplate(a.name,a.action,e.template),e.run=function(a){d.context.load(d.executionUnit,c(a))},e},window.stik.labs.boundary=function(a){function b(a){var b={};for(dbl in a)b[dbl]=window.stik.injectable({module:a[dbl]});return b}if(!a)throw"Stik: Boundary Lab needs an environment to run";if(!a.name)throw"Stik: Boundary Lab needs a name";var c={};return boundary=window.stik.$$manager.getBoundary(a.name),c.run=function(a){return boundary.to.resolve(b(a))},c};